# 湯めぐり手帳 要件定義・設計書

## 1. プロジェクト概要

カレンダー形式で日々の銭湯訪問を記録し、管理するアプリ「湯めぐり手帳」。個人の記録を楽しく続けられるだけでなく、新たな銭湯発見のきっかけも提供する。

## 2. アプリのコンセプト

**「日々の銭湯巡りを、もっと楽しく、もっと深く。」**

カレンダーに記録を残す手軽さはそのままに、サウナや水風呂といった「こだわりポイント」の記録や、訪問の積み重ねが可視化される「お楽しみ機能」を追加。ライトな銭湯ファンから熱心なサウナーまで、すべての銭湯好きが自分だけの「ととのい記録」を育てていけるアプリを目指す。

---

## 3. 機能要件

### 3.1. コア機能

* **カレンダー表示**: 訪問日をアイコン（例: 🛁）で直感的に把握できる。
* **記録の追加・編集**: 日付をタップし、その日の訪問記録を登録・編集できる。
* **過去記録の閲覧**: カレンダーやリスト形式で過去の記録を検索・閲覧できる。

### 3.2. 銭湯検索・登録機能

* **API連携**: Google Places APIを利用し、「銭湯」「温泉」「スパ」等のキーワードで施設を検索。
* **周辺検索**: 現在地周辺の銭湯を自動でリストアップ・地図表示。
* **情報取得**: 検索結果から施設を選択すると、以下の情報を可能な限り自動で取得・表示する。
    * 施設名、住所、電話番号、ウェブサイト
    * 営業時間、料金情報
    * Google上のユーザーレビュー・評価、写真

### 3.3. 地図連携機能

* **位置確認**: Google Maps上で銭湯の場所を確認できる。
* **記録の可視化**: 記録済みの銭湯をマップ上にピンで表示する。
* **ルート案内**: Google Mapsアプリと連携し、目的地までのルート案内を開始できる。

### 3.4. 詳細記録機能

* **基本情報**:
    * **訪問時間・料金**: 滞在時間と支払った料金を記録。
* **お風呂の種類・設備**:
    * チェックボックス形式で、体験した設備を選択可能。（例: 熱め風呂, ジェットバス, サウナ, 露天風呂など）
    * もし無ければ、自分で選択肢を追加することも可能。
* **体験の評価（5段階）**:
    * **総合評価**: 全体を総合した星評価。
    * **清潔感**: 施設全体の清潔さ。
    * **混雑度**: 利用時の混み具合。
    * **接客**: スタッフの対応。
    * **居心地**: 全体的な雰囲気や快適さ。
* **メモ・感想**:
    * 自由記述のコメント。
* **写真**:
    * 訪問時に撮影した写真を複数枚添付可能。
* **リピート意向**:
    * 「絶対また行きたい！」「機会があれば」「一度で満足」の3段階で記録。

### 3.5. 統計・分析機能

* **ダッシュボード**: 月間・年間の訪問回数、総支出額、訪問施設数を表示。
* **ランキング**: 訪問回数や自身の評価に基づいたマイランキングを作成。

### 3.6. エンゲージメント機能

* **称号・バッジシステム**: 「渋谷区制覇」「月間10回訪問」など、特定の条件で獲得できる。
* **行きたいリスト**: 気になった銭湯をブックマークできる。

### 3.7. データ管理機能

* **データ同期・バックアップ**: アカウントに紐づくデータをクラウドに保存し、機種変更時にも対応。

---

## 4. 画面設計・ユーザーフロー

### 4.1. 主要画面構成（タブナビゲーション）

1.  **カレンダー**（ホーム）
2.  **マップ**
3.  **マイページ**（統計・バッジ・行きたいリスト）
4.  **設定**

### 4.2. 画面イメージ

#### ① カレンダー画面（ホーム）

    [年月表示] [< >] [今日へ]
    ┌─────────────────┐
    │  日 月 火 水 木 金 土  │
    │   1  2  3  4  5  6  7  │
    │   8  9 10 11 12 13 14  │ ← 訪問日に湯マーク🛁表示
    │  15 16 17 18 19 20 21  │
    └─────────────────┘

    [今日の記録]
    🛁 山田湯 18:00-20:00 ⭐⭐⭐⭐⭐

    [+ 新しい記録を追加] (FAB)

#### ② 記録追加フロー

**Step 1: 銭湯検索**

    [検索バー: "銭湯名で検索..."]
    [📍現在地周辺の銭湯]

    ┌─────────────────┐
    │ 🛁 山田湯                │
    │    東京都渋谷区... 500m  │
    │    ⭐4.2 | ¥520        │
    └─────────────────┘
    ...
    [手動で追加] [地図から選択]

**Step 2: 記録詳細入力**

    🛁 [山田湯] ← 検索から自動入力
    [日付] 2025/07/05

    [♨️ お風呂・設備]
    [☑️熱め風呂] [☑️ジェットバス] [☑️サウナ]
    [⬜️電気風呂] [☑️水風呂] [☑️露天風呂] [+] ← タップで選択肢を追加

    [⭐ 体験の評価]
      総合評価: ⭐⭐⭐⭐⭐
      清潔感　: ⭐⭐⭐⭐
      混雑度　: ⭐⭐
      接客　　: ⭐⭐⭐⭐⭐
      居心地　: ⭐⭐⭐⭐

    [🔁 また行きたい？]
    (◉) 絶対また行きたい！ ( ) 機会があれば ( ) 一度で満足

    [💬 コメント]
    ┌─────────────────┐
    │水風呂がキンキンで最高！ │
    └─────────────────┘

    [📷 写真を追加]

    [保存]

### 4.3. 主要ユーザーフロー

* **記録追加フロー**:
    `カレンダー画面` → `[+ 新規記録]` → `銭湯検索画面` → `[銭湯選択]` → `記録詳細入力画面` → `[保存]` → `カレンダー画面に反映`
* **銭湯発見フロー**:
    `マップ画面` → `[周辺の銭湯ピンをタップ]` → `銭湯情報ポップアップ` → `[記録を追加]` or `[行きたいリストに追加]`

---

## 5. 技術要件

### 5.1. 基本構成

* **フレームワーク**: **React Native 0.79.5**
* **言語**: **TypeScript 5.8.3**
* **開発基盤**: **Expo SDK 53.0.20**
* **React**: **19.0.0**

### 5.2. 開発環境

| 環境 | 用途 | 対応機能 |
| :--- | :--- | :------- |
| **Expo Go** | UI/UX開発・高速プロトタイピング | カレンダー、プロフィール、設定、基本ナビゲーション |
| **Development Build** | ネイティブ機能・実機テスト | react-native-maps、位置情報、Google Places API |

### 5.3. 主要ライブラリ

| 目的           | ライブラリ名                                | 対応環境 |
| :------------- | :------------------------------------------ | :------- |
| ナビゲーション | **Expo Router 5.1.4**                      | 両方 |
| 状態管理       | **Zustand 5.0.6**                          | 両方 |
| ローカルDB     | **AsyncStorage 2.1.2**                     | 両方 |
| カレンダーUI   | **react-native-calendars 1.1313.0**        | 両方 |
| 地図機能       | **react-native-maps** (WebMapView実装)      | Development Build |
| 位置情報取得   | **expo-location 18.1.6**                   | 両方 |
| 銭湯検索       | **react-native-google-places-autocomplete 2.5.7** | 両方 |
| 開発クライアント | **expo-dev-client 5.2.4**                | Development Build |

### 5.4. ハイブリッド開発システム

アプリは実行環境を自動判定し、最適な機能を提供します：

```typescript
// 環境判定システム
const isExpoGo = Constants.executionEnvironment === 'storeClient';

if (isExpoGo) {
  // Expo Go: プレースホルダー表示
  return <ExpoGoPlaceholder />;
} else {
  // Development Build: 実際のネイティブ機能
  return <NativeMapView />;
}
```

### 5.3. バックエンド・データ管理

データ同期・バックアップの実現のため、**Firebase**をバックエンドとして利用する。

* **認証**: **Firebase Authentication** (Google, Apple, メール等)
* **データベース**: **Cloud Firestore**
* **ストレージ**: **Cloud Storage for Firebase**

### 5.4. データ構造（Firestore）

```javascript
// /visits/{visit_id}
{
  id: "unique_visit_id",
  userId: "user_auth_id",
  date: "2025-07-05",
  createdAt: "timestamp",

  // 施設情報
  placeId: "google_place_id",
  name: "○○湯",
  address: "東京都...",
  coordinates: { lat: 35.xxx, lng: 139.xxx },

  // ユーザー記録
  visitTime: "18:00-20:00",
  fee: 520,
  comment: "水風呂がキンキンで最高！",
  photos: ["[https://firebasestorage.googleapis.com/](https://firebasestorage.googleapis.com/)..."],

  // 設備（チェックボックス）
  facilities: ["熱め風呂", "ジェットバス", "サウナ", "水風呂", "露天風呂"],

  // 評価
  ratings: {
    overall: 5,
    cleanliness: 4,
    crowdedness: 2,
    service: 5,
    comfort: 4
  },

  // リピート意向
  repeatIntention: "definitely", // "definitely", "maybe", "once"

  // サウナー向け詳細記録（オプション）
  saunaDetails: {
    sauna: { temp: 90, rating: 5 },
    waterBath: { temp: 16, rating: 5 },
    totonoiSpace: { exists: true, rating: 4 }
  }
}
```

### 5.5. キャッシュ戦略

アプリの応答性を高め、オフラインでも快適に利用できるよう、以下のキャッシュ戦略を採用する。

#### 5.5.1. 基本戦略：ローカルファースト

  * **テキストデータ**: Firestoreの強力なオフラインキャッシュ機能を最大限に活用する。ユーザーの記録（訪問日、評価、コメント等）は、まず端末内に保存され、バックグラウンドで自動的にクラウドと同期される。これにより、電波がない場所でも記録の追加・閲覧が可能。
  * **施設情報データ**: Google Places APIから取得した施設情報（住所、営業時間など）も一定期間（例: 7日間）キャッシュし、APIへの問い合わせ回数を削減する。

#### 5.5.2. 画像キャッシュ

  * **ライブラリ**: `react-native-fast-image` 等のライブラリを導入し、一度表示した画像は積極的にキャッシュする。
  * **キャッシュの種類**:
      * **サムネイルキャッシュ（自動）**: 一覧画面などで表示する小さな画像は、常にキャッシュする。
      * **高画質キャッシュ（オプション）**: ユーザーが設定で有効にした場合のみ、詳細画面で表示する高画質な画像をキャッシュする。これにより、ストレージ容量を節約したいユーザーのニーズにも応える。

#### 5.5.3. キャッシュ管理設定

ユーザーが自身のデータ使用量やストレージを管理できるよう、「設定」画面に以下の項目を設ける。

  * **画像キャッシュの上限サイズ**: キャッシュとして保存する画像の最大容量を設定できる。（例: 50MB, 100MB, 250MB, 無制限）
  * **キャッシュの自動クリーンアップ**: 上限サイズを超えた場合、または長期間アクセスされていない画像キャッシュを自動で削除する機能。（ON/OFF）
  * **Wi-Fi接続時のみ同期**: 写真などの大容量データは、Wi-Fi接続時にのみアップロード/ダウンロードする設定。（ON/OFF）
  * **キャッシュクリア**: 全ての画像キャッシュを手動で削除するボタンを設置。

-----

## 6. 非機能要件

アプリの品質、信頼性、使いやすさを担保するための要件。

### 6.1. パフォーマンス

  * **応答性**: ユーザーの操作から2秒以内に画面が応答を返すこと。
  * **起動時間**: アプリの初回起動は5秒以内、2回目以降は2秒以内を目指す。
  * **スクロール性能**: 記録リストや検索結果のスクロールは、カクつきなくスムーズに表示されること（60fpsを目標）。

### 6.2. 可用性・信頼性

  * **サーバー稼働率**: FirebaseのSLA（Service Level Agreement）に準拠し、高い稼働率を維持する。
  * **オフライン対応**: Firestoreのオフラインキャッシュ機能により、ネットワーク接続がない状態でも記録の作成・閲覧・編集が可能であること。
  * **エラーハンドリング**: API通信エラーやネットワーク切断が発生した際は、ユーザーに分かりやすいメッセージを表示し、アプリが強制終了しないこと。

### 6.3. セキュリティ

  * **通信の暗号化**: すべての通信はHTTPSを用いて暗号化する（Firebaseが標準で対応）。
  * **データアクセス制御**: Firestoreのセキュリティルールを適切に設定し、ユーザーは自身のデータにのみアクセスできるようにする。他人のデータを閲覧・改ざんできないこと。
  * **APIキーの管理**: Google Maps APIなどのキーは、クライアント側に直接含めず、適切な方法で保護・管理する。
  * **プライバシー**: 位置情報など、ユーザーの許可なく個人情報を取得・利用しない。プライバシーポリシーを明記し、ユーザーの同意を得るプロセスを設ける。

### 6.4. ユーザビリティ・アクセシビリティ

  * **直感的な操作**: マニュアルを読まなくても、主要な機能が直感的に使えること。
  * **一貫性のあるUI**: アプリ内のボタンや配色、レイアウトに一貫性を持たせる。
  * **アクセシビリティ**: OSの標準的なフォントサイズ変更にある程度追従するなど、基本的なアクセシビリティに配慮する。（将来的な改善項目として検討）

### 6.5. 保守性・運用性

  * **コード品質**: TypeScriptの型システムを活用し、可読性が高くメンテナンスしやすいコードを記述する。
  * **エラー監視**: Firebase Crashlyticsを導入し、アプリのクラッシュレポートを自動で収集・分析できるようにする。
  * **アップデート**: App Store / Google Play Storeの審査ガイドラインを遵守し、スムーズなアプリのアップデートが行えるようにする。

-----

## 7. 開発ロードマップ（提案）

  * **Phase 1 (MVPリリース)**: `3.1`, `3.2`, `3.3` のコア機能を実装。
  * **Phase 2 (機能拡張)**: `3.4`, `3.5`, `3.7` の詳細記録、統計、データ同期を実装。
  * **Phase 3 (エンゲージメント強化)**: `3.6` のバッジ機能などを実装。
