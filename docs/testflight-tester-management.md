# TestFlightテスター管理ガイド

## TestFlightの基本概念

TestFlightはApple公式のベータテスト配信プラットフォームです。最大10,100名のテスターにアプリを配布できます。

## アプリバリアント対応（2025年1月更新）

このプロジェクトでは、**Development** と **Production** の2つのアプリバリアントをTestFlightで同時に配布・管理できます。

### バリアント構成

| バリアント | アプリ名 | Bundle Identifier | TestFlightでの表示 |
|-----------|---------|------------------|-------------------|
| **Development** | 湯めぐり手帳 (Dev) | `com.yumeguri.techou.dev` | 別アプリとして表示 |
| **Production** | 湯めぐり手帳 | `com.yumeguri.techou` | メインアプリとして表示 |

### バリアント管理のメリット

- **並行テスト**: 新機能のテスト（Dev版）と安定版のテスト（Production版）を同時実施
- **リスク分離**: Development版でのクラッシュがProduction版テストに影響しない  
- **段階的展開**: Development版で限定テスト後、Production版で本格展開
- **明確な区別**: アプリ名とアイコンで一目で判別可能

### テスターの種類

| 種類 | 上限 | 条件 | 審査 | 用途 |
|------|------|------|------|------|
| **内部テスター** | 100名 | App Store Connectチームメンバー | なし | 開発チーム内テスト |
| **外部テスター** | 10,000名 | Apple IDを持つ任意のユーザー | あり（24-48時間） | 一般ユーザーベータテスト |

### Internal Distributionとの違い

| 項目 | TestFlight | Internal Distribution |
|------|------------|----------------------|
| デバイス登録 | 不要 | UDIDの事前登録必要 |
| 配布上限 | 10,100名 | 100デバイス/年 |
| 配布方法 | TestFlightアプリ | URLまたは直接インストール |
| Apple審査 | あり（外部のみ） | なし |

## 事前準備

### 1. App Store Connectでのアプリ設定

1. **App Store Connectにログイン**
   ```
   https://appstoreconnect.apple.com
   ```

2. **アプリの作成（未作成の場合）**
   
   **Production版アプリ（メインアプリ）**:
   - 「マイApp」→「新しいApp」をクリック
   - **プラットフォーム**: iOS
   - **名前**: 湯めぐり手帳
   - **主要言語**: 日本語
   - **Bundle ID**: `com.yumeguri.techou`
   - **SKU**: `yumeguri-techou-prod`
   
   **Development版アプリ（テスト用）**:
   - 「マイApp」→「新しいApp」をクリック
   - **プラットフォーム**: iOS
   - **名前**: 湯めぐり手帳 (Dev)
   - **主要言語**: 日本語
   - **Bundle ID**: `com.yumeguri.techou.dev`
   - **SKU**: `yumeguri-techou-dev`

3. **アプリ情報の入力**
   - **App情報** → **一般情報**
   - **カテゴリ**: ライフスタイル
   - **サブカテゴリ**: 該当なし
   - **コンテンツレーティング**: 適切な年齢制限を設定

### 2. ビルドの作成・提出

**Production版（メインアプリ）**:
```bash
# 1. プロダクションビルド作成
pnpm run build:prod

# 2. TestFlightに提出
eas submit --platform ios
```

**Development版（テスト用アプリ）**:
```bash
# 1. Development ビルド作成
pnpm run build:dev

# 2. TestFlightに提出
eas submit --platform ios
```

提出後、App Store Connectの「TestFlight」タブで各アプリのビルドが表示されるまで5-15分待機。
**注意**: 各バリアントは別々のアプリとして表示されます。

## 内部テスターの追加

### Step 1: App Store Connectユーザーの招待

1. **ユーザー管理画面へ移動**
   - App Store Connect → 「ユーザーとアクセス」
   - 「ユーザー」タブを選択

2. **新しいユーザーの招待**
   - 「+」ボタン → 「新しいユーザーを招待」
   - **メールアドレス**: テスターのApple ID
   - **名前**: テスターの氏名
   - **役割**: 「デベロッパー」または「マーケティング」を選択
   - **アプリ権限**: 「湯めぐり手帳」にチェック

3. **権限の設定**
   - **TestFlight**: 「アクセス」にチェック
   - **App Store Connect**: 必要に応じて設定
   - 「招待」をクリック

### Step 2: TestFlightでの内部テスト設定

1. **内部テストグループの設定**
   - アプリ選択 → 「TestFlight」タブ
   - 「内部テスト」セクション
   - 「App Store Connectユーザー」を選択

2. **テスターの追加**
   - 「テスターを追加」をクリック
   - 招待済みのユーザーから選択
   - 「追加」をクリック

3. **テスト開始**
   - ビルドを選択
   - 「テストを開始」をクリック
   - 招待メールが自動送信される

## 外部テスターの追加

### Step 1: 外部テストグループの作成

1. **新しいグループの作成**
   - 「TestFlight」タブ → 「外部テスト」
   - 「新しいグループを作成」をクリック
   - **グループ名**: 「ベータテスター」（任意）
   - **説明**: グループの目的を記載

### Step 2: テスト情報の設定

1. **ベータ版App情報の入力**
   - **ベータ版App の説明**: アプリの機能と目的を詳しく記載
   ```
   「湯めぐり手帳」は銭湯・温泉の訪問記録を管理するiOSアプリです。
   GPS機能で周辺の銭湯を検索し、訪問履歴をカレンダーで管理できます。
   ```
   
   - **フィードバックのメールアドレス**: サポート用メールアドレス
   - **マーケティングURL**: 必要に応じて設定

2. **テストの詳細**
   - **テストしたい内容**: 具体的なテスト項目
   ```
   - GPS機能による周辺銭湯検索の精度
   - 訪問記録の作成・編集機能
   - カレンダー表示の使いやすさ
   - アプリの全体的な安定性
   ```

### Step 3: テスターの招待

1. **テスターの追加**
   - 作成したグループを選択
   - 「テスターを追加」をクリック
   - **メールアドレス**: テスターのApple ID（改行区切りで複数入力可能）
   - **名前**: 省略可能（メールアドレスのみでもOK）

2. **招待の送信**
   - 「次へ」をクリック
   - 招待メッセージを確認・編集
   - 「招待を送信」をクリック

### Step 4: ビルドの割り当てと審査

1. **ビルドの選択**
   - グループにビルドを割り当て
   - 最新のビルドを選択

2. **Apple審査の提出**
   - 「審査に提出」をクリック
   - 審査完了まで24-48時間待機

## テスター側の参加手順

### 1. TestFlightアプリのインストール
```
App Store → 「TestFlight」で検索 → インストール
```

### 2. 招待の受諾
1. 招待メールを確認（迷惑メールフォルダも確認）
2. メール内の「TestFlightで表示」リンクをタップ
3. TestFlightアプリが開く
4. 「承諾してテスト開始」をタップ

### 3. アプリのインストール
1. TestFlightアプリ内で「湯めぐり手帳」を選択
2. 「インストール」をタップ
3. インストール完了後、通常のアプリと同様に利用可能

## よくある問題と解決策

### テスター招待関連

#### Q: 「このメールアドレスは既に使用されています」エラー
**原因**: 招待メールアドレスが別のApple IDで使用済み

**解決策**:
1. テスターに実際に使用しているApple IDを確認
2. 設定 > Apple ID で確認してもらう
3. 正しいApple IDで再招待

#### Q: テスターが招待メールを受信しない
**原因**: 
- 迷惑メールフォルダに振り分け
- メールアドレスの誤入力

**解決策**:
1. 迷惑メールフォルダの確認を依頼
2. メールアドレスの再確認
3. App Store Connect上でテスター状況を確認

#### Q: TestFlightアプリでアプリが表示されない
**原因**:
- 招待の受諾が完了していない
- 外部テスターの場合、Apple審査が未完了

**解決策**:
1. 招待メールのリンクを再度タップ
2. Apple審査状況をApp Store Connectで確認
3. 必要に応じて再招待

### Apple審査関連（外部テスター）

#### Q: 外部テスターの審査が却下される
**よくある却下理由**:
- アプリの説明が不十分
- テスト内容が不明確
- フィードバック収集方法が不適切

**解決策**:
1. **ベータ版App の説明**を詳細に記載
2. **テストの詳細**で具体的なテスト項目を列挙
3. **フィードバックのメールアドレス**を有効なものに設定
4. 修正後に再審査申請

#### Q: 審査に時間がかかりすぎる
**一般的な審査時間**: 24-48時間

**長期化する場合**:
1. App Store Connect Developer Forums で状況確認
2. Apple Developer Supportに問い合わせ

### デバイス・制限関連

#### Q: デバイス数の制限はありますか？
**TestFlight**: デバイス数制限なし（テスター人数制限のみ）
**Internal Distribution**: 年間100デバイスまで

#### Q: テスターの入れ替えは可能？
**可能**: テスターの削除・追加は随時可能
**注意**: 削除したテスターは再度招待が必要

## テスター管理のベストプラクティス

### 1. アプリバリアント別の段階的展開
```
【Development版】
Phase 1: 内部テスター（3-5名）→ 新機能の基本動作確認
Phase 2: 外部テスター（20-50名）→ 限定的なベータテスト

【Production版】  
Phase 1: 内部テスター（5-10名）→ 安定版の最終確認
Phase 2: 外部テスター（100-300名）→ 本格的なベータテスト
Phase 3: 外部テスター拡大（500-1000名）→ 大規模リリース準備
```

### 2. フィードバック収集
- **専用メールアドレス**: testflight@yourcompany.com
- **フィードバックフォーム**: Google Forms等の活用
- **定期的なアンケート**: テスト期間中の進捗確認

### 3. テスト期間の設定
- **内部テスト**: 1-2週間
- **外部テスト**: 2-4週間
- **フィードバック集約**: テスト終了後1週間

### 4. アップデート配信（バリアント別）

**Production版のアップデート**:
```bash
# 1. アプリ更新（app.config.js でbuildNumberを増加）

# 2. 新しいビルド作成・提出  
pnpm run build:prod
eas submit --platform ios

# 3. TestFlightで新ビルドを既存グループに割り当て
# テスターに自動で更新通知が送信される
```

**Development版のアップデート**:
```bash  
# 1. アプリ更新（app.config.js でbuildNumberを増加）

# 2. Development ビルド作成・提出
pnpm run build:dev
eas submit --platform ios

# 3. TestFlightでDevelopment版アプリのグループに割り当て
```

## 関連リソース

- [Apple Developer Documentation - TestFlight](https://developer.apple.com/testflight/)
- [App Store Connect ヘルプ](https://help.apple.com/app-store-connect/)
- [プロジェクト関連ドキュメント](./build-and-distribute.md)

---

このガイドに従って、効果的なベータテストプログラムを実施してください。